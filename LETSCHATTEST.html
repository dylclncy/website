<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading....</title>
    <link rel="shortcut icon" href="favicon_io/favicon.ico" type="image/x-icon">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f0f0; }
        .comment-box { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
        .comment { border-bottom: 1px solid #ddd; padding: 10px 0; }
        .comment:last-child { border-bottom: none; }
        .comment strong { display: block; }
        .timestamp { font-size: 0.8em; color: gray; }
        textarea, input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; resize: none; margin-top: 5px; }
        button { margin-top: 10px; padding: 10px 20px; border: none; border-radius: 5px; background: #4CAF50; color: white; cursor: pointer; }
        button:hover { background: #45a049; }
        .reply-box { margin-left: 30px; margin-top: 10px; }
        .reply-input { width: 90%; margin-top: 5px; }
        .reply-container { display: none; margin-top: 10px; }
        .delete-btn { background: #e74c3c; margin-left: 10px; }
        .delete-btn:hover { background: #c0392b; }
    </style>
</head>
<body>

<div class="comment-box">
    <h2>Comments</h2>

    <div id="auth-section">
        <input type="text" id="username" placeholder="Username" />
        <input type="email" id="email" placeholder="Email" />
        <input type="password" id="password" placeholder="Password" />
        <button id="signupBtn">Sign Up</button>
        <button id="loginBtn">Log In</button>
        <button id="logoutBtn" style="display:none;">Log Out</button>
    </div>

    <div id="comments-section"></div>

    <textarea id="comment-text" rows="4" placeholder="Add a comment..." disabled></textarea>
    <button id="postBtn" disabled>Post Comment</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
    import { getFirestore, collection, addDoc, deleteDoc, doc, serverTimestamp, onSnapshot, query, orderBy, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBWz_yH__HdxJgE9qr-d8rS5i05y9vmg90",
        authDomain: "website-4bd47.firebaseapp.com",
        projectId: "website-4bd47",
        storageBucket: "website-4bd47.appspot.com",
        messagingSenderId: "504550866946",
        appId: "1:504550866946:web:4bb73454765667b824671b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();

    const commentsSection = document.getElementById('comments-section');
    const postBtn = document.getElementById('postBtn');
    const commentText = document.getElementById('comment-text');
    const signupBtn = document.getElementById('signupBtn');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const commentsQuery = query(collection(db, 'comments'), orderBy('timestamp', 'asc'));

    onSnapshot(commentsQuery, (snapshot) => {
        commentsSection.innerHTML = '';
        snapshot.forEach((docSnap) => {
            const commentData = docSnap.data();
            const commentId = docSnap.id;
            const user = auth.currentUser;

            const commentDiv = document.createElement('div');
            commentDiv.classList.add('comment');

            const timestamp = commentData.timestamp?.toDate();
            const formattedDate = timestamp ? timestamp.toLocaleString('en-US', { month: 'short', day: 'numeric' }) : '';

            commentDiv.innerHTML = `
                <strong>${commentData.username}</strong>
                <span class="timestamp">${formattedDate}</span>
                <p>${commentData.text}</p>
                <button onclick="toggleReplies('${commentId}')">View Replies</button>
                ${user && user.displayName === commentData.username ? `<button class="delete-btn" onclick="deleteComment('${commentId}')">Delete</button>` : ''}
                <div class="reply-container" id="replies-container-${commentId}">
                    <textarea rows="2" placeholder="Reply..." class="reply-input" id="reply-${commentId}"></textarea>
                    <button onclick="postReply('${commentId}')">Reply</button>
                    <div class="reply-box" id="replies-${commentId}"></div>
                </div>
            `;

            commentsSection.appendChild(commentDiv);

            // Replies listener
            const repliesQuery = query(collection(db, 'comments', commentId, 'replies'), orderBy('timestamp', 'asc'));
            onSnapshot(repliesQuery, (replySnapshot) => {
                const repliesDiv = document.getElementById(`replies-${commentId}`);
                repliesDiv.innerHTML = '';
                replySnapshot.forEach((replyDoc) => {
                    const replyData = replyDoc.data();
                    const replyTimestamp = replyData.timestamp?.toDate();
                    const replyDate = replyTimestamp ? replyTimestamp.toLocaleString('en-US', { month: 'short', day: 'numeric' }) : '';

                    const replyDiv = document.createElement('div');
                    replyDiv.innerHTML = `<strong>${replyData.username}</strong> <span class="timestamp">${replyDate}</span><p>${replyData.text}</p>`;
                    repliesDiv.appendChild(replyDiv);
                });
            });
        });
    });

    window.postReply = async function(commentId) {
        const replyInput = document.getElementById(`reply-${commentId}`);
        const replyText = replyInput.value.trim();
        if (replyText === '') return;

        const user = auth.currentUser;

        await addDoc(collection(db, 'comments', commentId, 'replies'), {
            username: user.displayName,
            text: replyText,
            timestamp: serverTimestamp()
        });

        replyInput.value = '';
    };

    window.toggleReplies = function(commentId) {
        const container = document.getElementById(`replies-container-${commentId}`);
        container.style.display = (container.style.display === 'none' || container.style.display === '') ? 'block' : 'none';
    };

    window.deleteComment = async function(commentId) {
        if (confirm('Are you sure you want to delete this comment?')) {
            await deleteDoc(doc(db, 'comments', commentId));
        }
    };

    postBtn.addEventListener('click', async () => {
        const text = commentText.value.trim();
        if (text === '') return;

        const user = auth.currentUser;

        await addDoc(collection(db, 'comments'), {
            username: user.displayName,
            text: text,
            timestamp: serverTimestamp()
        });

        commentText.value = '';
    });

    async function isUsernameTaken(username) {
        const usernameRef = doc(db, 'usernames', username);
        const usernameSnap = await getDoc(usernameRef);
        return usernameSnap.exists();
    }

    signupBtn.addEventListener('click', async () => {
        const username = document.getElementById('username').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        if (username === '' || email === '' || password === '') return alert('Fill in all fields.');

        if (await isUsernameTaken(username)) {
            return alert('Username is already taken. Please choose another.');
        }

        createUserWithEmailAndPassword(auth, email, password)
            .then(async (userCredential) => {
                await updateProfile(userCredential.user, { displayName: username });
                await setDoc(doc(db, 'usernames', username), { uid: userCredential.user.uid });
                alert('Signed up successfully!');
            })
            .catch(error => alert(error.message));
    });

    loginBtn.addEventListener('click', () => {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();

        if (email === '' || password === '') return alert('Enter email and password.');

        signInWithEmailAndPassword(auth, email, password)
            .then(() => {
                alert('Logged in!');
            })
            .catch(error => alert(error.message));
    });

    logoutBtn.addEventListener('click', () => {
        signOut(auth).then(() => alert('Logged out!'));
    });

    onAuthStateChanged(auth, (user) => {
        if (user) {
            postBtn.disabled = false;
            commentText.disabled = false;
            logoutBtn.style.display = 'inline-block';
            signupBtn.style.display = 'none';
            loginBtn.style.display = 'none';
        } else {
            postBtn.disabled = true;
            commentText.disabled = true;
            logoutBtn.style.display = 'none';
            signupBtn.style.display = 'inline-block';
            loginBtn.style.display = 'inline-block';
        }
    });
</script>

</body>
</html>





